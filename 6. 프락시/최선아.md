# 6. 프락시

- 웹 프락시 서버는 클라이언트와 서버 사이의 중개자임
- 프락시는 클라이언트와 서버 사이에 위치하여 사이에서 HTTP 메시지를 정리하는 역할을 함

## 6.1 웹 중개자

<img width="425" alt="Image" src="https://github.com/user-attachments/assets/650efdcd-dfad-4d93-8162-ba254b3f837d" />

**프락시의 기본 동작**

- 프락시는 클라이언트를 대신해 트랜잭션을 수행하는 중개인임
- 프락시가 없으면 클라이언트가 HTTP 서버와 직접 통신함
- 프락시가 있으면 클라이언트는 프락시와 통신하고, 프락시가 서버와 통신을 대행함

**프락시의 이중 역할**

- 프락시는 웹 서버와 웹 클라이언트의 특성을 모두 가짐
- 클라이언트로서: 서버에 요청을 보내고 응답을 받아 처리함
- 서버로서: 클라이언트의 요청과 커넥션을 처리하고 응답을 제공함
- HTTP 프락시 개발 시 클라이언트와 서버 양쪽의 HTTP 규칙을 모두 준수해야 함

### 6.1.1 개인 프락시와 공유 프락시

**공용 프락시**

- 여러 클라이언트가 공유하여 사용하는 프락시
- 특징:
  - 대부분의 프락시는 공용이며 공유된 프락시임
- 장점:
  - 중앙 집중형 관리로 비용 효율적이고 관리가 용이함
  - 캐시 프락시의 경우 사용자가 많을수록 공통 요청에서 더 큰 이점을 얻을 수 있음

**개인 프락시**

- 단일 클라이언트가 독점적으로 사용하는 프락시
- 특징:
  - 흔하지는 않지만 꾸준히 사용되고 있음
  - 주로 클라이언트 컴퓨터에서 직접 실행됨
  - 브라우저 보조 제품 형태로 사용
- 주요 용도:
  - 브라우저 기능 확장
  - 성능 개선
  - 무료 ISP 서비스를 위한 광고 운영

> ISP가 뭐지?, 실제 예시가 뭐가 있을까?

### 6.1.2 프락시 대 게이트웨이

<img width="419" alt="Image" src="https://github.com/user-attachments/assets/e654ae2e-1137-4508-8380-15e9b8499613" />

**기본 개념 차이**

- 프락시: 동일한 프로토콜을 사용하는 애플리케이션들을 연결
- 게이트웨이: 서로 다른 프로토콜을 사용하는 애플리케이션들을 연결

**게이트웨이의 특징**

- 프로토콜 변환기 역할을 수행
- 서로 다른 프로토콜 간의 트랜잭션 완료를 지원
- 예시: HTTP/POP 게이트웨이
  - HTTP로 들어온 요청을 POP 이메일 프로토콜로 변환하고, 사용자가 이메일을 HTTP를 통해 읽을 수 있게 해줌
  - 웹 기반 이메일 서비스(Yahoo Mail, MSN Hotmail 등)가 대표적

**현실적 구분의 모호성**

- 브라우저와 서버가 다른 버전의 HTTP일 때 프락시도 HTTP 버전 간 변환 수행같은 약간의 프로토콜 변환을 하기도 함
- 상용 프락시 서버들은 다양한 게이트웨이 기능 포함:

  - SSL 보안 프로토콜
  - SOCKS 방화벽
  - FTP 접근
  - 웹 기반 애플리케이션 지원

- 이처럼 이론적 구분과 달리 실제로는 프락시와 게이트웨이의 경계가 불분명한 경우가 많음

> SOCKS, FTP, SSL 이 정확히 뭐지??

## 6.2 왜 프락시를 사용하는가?

- 프락시 서버는 보안 개선, 성능 개선, 비용 절약 등 실용적이고 유용한 일을 함
- 프락시는 모든 HTTP 트래픽을 들여다보고 건드릴 수 있기 때문에, 부가적인 가치를 주는 여러 유용한 웹 서비스를 구현하기 위해 트래픽을 감시하고 수정할 수 있음

### 어린이 필터

<img width="419" alt="Image" src="https://github.com/user-attachments/assets/8bcb8fc8-6f90-4b0c-b6fe-0ff7e174fdf4" />

**핵심 기능**

- 학교에서 사용되는 필터링 프락시
- 교육용 콘텐츠와 유해 콘텐츠를 선별적으로 통제

**예시**

- 허용: 교육 콘텐츠에 대한 제한 없는 접근
- 차단: 어린이에게 부적절한 사이트 접근 강제 거부

> 어떻게 이게 가능한걸까? 어떤 기준으로 허용하고 차단하는걸까??

### 문서 접근 제어자

<img width="419" alt="Image" src="https://github.com/user-attachments/assets/a9ff613b-8b77-4f77-8e14-4f4686128d41" />

**핵심 기능**

- 여러 웹 서버와 리소스에 대한 중앙화된 접근 제어 제공
- 접근 기록에 대한 감사 추적 수행
- 대기업 환경이나 분산된 관료 조직에서 유용함

**장점**

- 개별 웹 서버마다 접근 제어를 설정할 필요 없음
- 중앙 프락시에서 일괄적으로 접근 권한 관리 가능

**예시**

- 클라이언트 1 에게 제약 없이 서버의 뉴스 페이지에 접근할 수 있도록 허가
- 클라이언트 2에게 제약 없이 인터넷 콘텐츠에 접근할 수 있는 권한을 줌
- 클라이언트 3이 서버 B에 접근하기 전에 먼저 비밀번호를요구

### 보안 방화벽

<img width="418" alt="Image" src="https://github.com/user-attachments/assets/503479bc-972b-4bb9-ba89-2510388dc3f9" />

**핵심 기능**

- 보안 강화
- 프로토콜 흐름 통제: 조직 내부/외부 트래픽을 네트워크의 한 지점에서 통제
- 트래픽 검사: 네트워크 트래픽을 세밀하게 검사하고 조취할 수 있는 hook 제공
  - 바이러스 검사
  - 트래픽 내용 분석
  - 악성 코드 제거
  - 유해 콘텐츠 필터링

> 방화벽이랑 방화벽 프락시는 뭐가 다를까?

### 웹 캐시

<img width="416" alt="Image" src="https://github.com/user-attachments/assets/b9dd11c4-eca8-4830-b657-2635ff416358" />

**핵심 기능**

- 자주 요청되는 문서의 로컬 복사본 저장 및 관리
- 저장된 문서에 대한 요청 시 빠른 응답 제공

**장점**

- 느리고 비싼 인터넷 커뮤니케이션을 줄임

### 대리 프락시

<img width="417" alt="Image" src="https://github.com/user-attachments/assets/f968c470-c9e4-4c02-a404-85465ebb50ef" />

**핵심 기능**

- 웹 서버처럼 위장하여 동작(리버스 프락시로도 불림)
- 요청받은 콘텐츠를 다른 서버에서 찾아옴

**장점**

- 서버 가속기

  - 공용 콘텐츠에 대한 느린 웹 서버의 성능 개선

- 콘텐츠 분산

  - 콘텐츠 라우팅과 결합되어 주문형 복제 콘텐츠의 분산 네트워크 구성
  - ex) 편의점처럼, 본사(메인 서버)의 상품을 각 지역 편의점(지역 서버)에 미리 배치해두는 것과 같은 개념

> 대리 프락시를 둔다고 어떻게 웹 서버의 성능을 개선한다는걸까??

### 콘텐츠 라우터

<img width="424" alt="Image" src="https://github.com/user-attachments/assets/be827dab-29ce-4f11-a240-288becab8a55" />

**핵심 기능**

- 트래픽 상태와 콘텐츠 유형에 따라 요청을 적절한 웹 서버로 전달
- 다양한 맞춤형 서비스 제공 가능

**예시**

- 성능 향상 서비스

  - 프리미엄 사용자의 요청을 가까운 캐시 서버로 전달
  - 더 빠른 응답 속도 제공

- 필터링 서비스

  - 필터링 서비스 가입자의 요청을 필터링 프락시로 전달
  - 콘텐츠 필터링 서비스 제공

### 트랜스코더

<img width="420" alt="Image" src="https://github.com/user-attachments/assets/de006db9-5624-41a2-8bf1-4e931d33df11" />

**핵심 기능**

- 콘텐츠의 본문을 변환

**예시**

- 이미지 변환

  - GIF → JPG 변환으로 용량 축소
  - 이미지 크기 조정
  - TV용 색상 강도 조절

- 텍스트 처리

  - 텍스트 파일 압축
  - 모바일 기기용 텍스트 크기 축소
  - 언어 번역 (한국어 → 스페인어)

### 익명화 프락시

<img width="418" alt="Image" src="https://github.com/user-attachments/assets/b71a2387-28ec-4146-a398-1cb0daa7e67a" />

**핵심 기능**

- HTTP 메시지에서 사용자 신원 식별 정보를 제거
- 개인 정보 보호와 익명성 보장

**예시**

- User-Agent 헤더 에서 사용자의 컴퓨터 와 OS의 종류를 제거
- 사용자의 이메일 주소를 보호하기 위해 From 헤더 제거
- 어떤 사이트를 거쳐서 방문했는지 알기 어 렵게 하기 위해 Referer 헤더 제거
- 프로필과 신원 정보를 없애기 위해 Cookie 헤더 제거

## 6.3 프락시는 어디에 있는가?

### 6.3.1 프락시 서버 배치

**출구 프락시**

<img width="401" alt="Image" src="https://github.com/user-attachments/assets/dd61e431-f7dc-47c1-8482-60d68810fa8a" />

- 로컬 네트워크의 출구에 설치되어 로컬 네트워크와 더 큰 인터넷 사이의 트래픽을 제어함
- 다음과 같은 목적으로 사용됨
  - 방화벽으로 외부 해커 차단
  - 인터넷 요금 절약
  - 인터넷 트래픽 성능 개선
  - 필터링을 통해 학생들의 부적절한 콘텐츠 접근 차단

**접근(입구) 프락시**

<img width="406" alt="Image" src="https://github.com/user-attachments/assets/9bad0003-91ed-42f8-b4c3-2391772a417d" />

- 요청을 종합적으로 처리하기 위해 프락시는 ISP 접근 지점에 위치하기도 함
- 다음과 같은 목적으로 사용됨
  - 사용자들의 다운로드 속도 개선(특히 고속 접속 사용자)
  - 자주 요청되는 문서들의 사본 저장
  - 인터넷 대역폭 비용 절감

**대리 프락시**

<img width="406" alt="Image" src="https://github.com/user-attachments/assets/f6e2c0a2-f5f9-4e82-9b4c-ceb7c5a231c9" />

- 네트워크 가장 끝에 있는 웹 서버들의 바로 앞에 위치함
- 웹 서버로 향하는 모든 요청을 처리하고 필요할 때만 웹 서버에서 자원을 요청할 수 있음
- 웹 서버의 이름과 IP 주소로 스스로를 가장하기 때문에, 모든 요청은 서버가 아닌 프락시로 가게 됨
- 다음과 같은 목적으로 사용됨
  - 웹 서버에 보안 기능 추가
  - 빠른 웹 서버 캐시를 느린 웹 서버의 앞에 놓음으로서 성능 개선

**네트워크 교환 프락시**

<img width="406" alt="Image" src="https://github.com/user-attachments/assets/8b68bec2-70c5-4b74-bd61-562dad9f01e6" />

- 네트워크 사이의 인터넷 피어링 교환 지점들에 놓임
- 다음과 같은 목적으로 사용됨
  - 캐시를 이용해 인터넷 교차로의 혼잡 완화
  - 트래픽 흐름 감시

> 인터넷 피어링 교환 지점이 뭘까?

### 6.3.2 프락시 계층

<img width="420" alt="Image" src="https://github.com/user-attachments/assets/f7259a0f-f6b6-4f7a-884f-0595170509a6" />

**프락시 계층의 구조**

- 여러 프락시들이 연쇄적으로 연결되어 계층을 형성
- 클라이언트의 요청이 순차적으로 프락시들을 거쳐 원 서버까지 전달됨
- 응답도 같은 경로를 통해 역순으로 클라이언트에게 전달

**프락시 간의 관계**

- 프락시 서버들은 부모와 자식의 관계를 가짐
- 다음번 인바운드 프락시(서버에 가까운 쪽)가 부모
- 다음번 아웃바운드 프락시(클라이언트 가까운 쪽)가 자식
- ex)
  - 프락시 2는 프락시 3의 자식 프락시
  - 프락시 3은 프락시 2의 부모 프락시

**프락시 계층 콘텐츠 라우팅**

<img width="418" alt="Image" src="https://github.com/user-attachments/assets/2b104fdc-f1de-4b1e-ba8d-5ede9ba048b5" />

- 프락시는 다양한 판단 근거로 메시지를 유동적으로 라우팅 가능
- ex)
  - 접근 프락시는 상황에 맞게 부모 프락시 또는 원서버에게 라우팅할 수 있음
  - 콘텐츠 분산을 위해 비용을 지불한 웹 서버: 가까운 캐시 서버로 전달
  - 특정 종류의 이미지 요청: 압축 프락시로 전달하여 빠른 다운로드 지원
  - **부하 균형**: 부하를 분산하기 위해 부모 프락시들의 작업량 수준에 근거하여 전달
  - **지리적 인접성에 근거한 라우팅**: 자식 프락시는 원 서버의 지역을 담당하는 부모를 선택할 수도 있음
  - **프로토콜/타입 라우팅**: 어떤 자식 프락시는 빠에 근거하여 다른 부모나 원 서버로 라우팅 할 수 있음. 요청 URI의 종류에 따라 특정 프로토콜을 처리하는 특별한 프락시 서버로 요청을 전달
  - **유료 서비스 가입자를 위한 라우팅**: 웹서비스 운영자가 추가 비용을 지불하면 대형 캐시나 성능 개선용 압축 엔진으로 라우팅하여 더 빠른 서비스 제공 가능

### 6.3.3 어떻게 프락시가 트래픽을 처리하는가

- 일반적으로 웹 서버와 직접 통신하는 클라이언트의 트래픽을 프락시로 보내기 위한 4가지 방법이 있음

**클라이언트를 수정한다**

<img width="206" alt="Image" src="https://github.com/user-attachments/assets/053c750e-c911-4a0f-a69d-d4fd7eeb5743" />

- 웹 브라우저(크롬, MS 브라우저 등)는 수동/자동 프락시 설정을 지원함
- 클라이언트가 프락시를 사용하도록 설정된 경우 HTTP 요청을 원 서버가 아닌 프락시로 보냄

**네트워크를 수정한다**

<img width="193" alt="Image" src="https://github.com/user-attachments/assets/bb5668af-2aa8-47d9-a3dc-f30fdb949bad" />

- **인터셉트 프락시**: 클라이언트는 알지도 못하고 간섭도 할 수 없는 상태에서, 네트워크 인프라를 가로채서 웹 트래픽을 프락시로 가도록함
- 이 가로챔은 일반적으로 HTTP 트래픽을 지켜보고 가로채어 클라이언트 모르게 트래픽을 프락시로 보내는 스위칭 장치와 라우팅 장치를 필요로 함

**DNS 이름공간을 수정한다**

<img width="206" alt="Image" src="https://github.com/user-attachments/assets/52141164-9dca-489e-8091-0eae41102f97" />

- 대리 프락시는 웹 서버의 이름과 IP 주소를 자신이 직접 사용하기 때문에 모든 요청은 서버 대신 대리 프락시로 감
- DNS 이름 테이블을 수동으로 편집하거나 사용할 적절한 프락시나 서버를 계산해주는 특별한 동적 DNS 서버를 이용해서 설정할 수 있음
- 이 경우 실제 서버의 IP 주소와 이름은 다른 것으로 변경됨

**웹 서버를 수정한다.**

<img width="200" alt="Image" src="https://github.com/user-attachments/assets/abe4fe62-6f93-4773-ae9a-c7542331515c" />

- 몇몇 웹 서버는 HTTP 리다이렉션 명령(응답 코드 305)을 클라이언트에게 돌려줌으로써 클라이언트의 요청을 프락시로 리다이렉트 하도록 설정할 수 있음
- 리다이렉트를 받는 즉시 클라이언트는 프락시와의 트랜잭션을 시작함

## 6.4 클라이언트 프락시 설정

- 모든 현대 브라우저는 프락시를 사용할 수 있도록 설정하는 여러 가지 방법을 제공함

**수동 설정**

- 프락시를 사용하겠다고 명시적으로 설정

**브라우저 기본 설정**

- 브라우저 벤더나 배포자는 브라우저(웹 클라이언트)를 소비자에게 전달하기 전에 프락시를 미리 설정해 놓을 수 있음

**프락시 자동 설정(Proxy Auto Configuration)**

- PAC는 자바스크립트로 작성된 설정 파일, 어떤 프락시 서버를 사용할지 자동으로 결정하는 규칙을 담고 있음
- 브라우저에 PAC 파일의 위치(URI)를 알려주면 브라우저는 파일을 내려받고, 자바스크립트가 상황에 따라 적절한 프락시를 선택함
- ex)
  - 회사 내부 사이트 접속 시 → 내부 프락시 사용
  - 외부 사이트 접속 시 → 외부 프락시 사용
  - 특정 사이트 접속 시 → 프락시 사용하지 않음

**WPAD 프락시 발견**

- 대부분의 브라우저는 자동설정 파일을 다운받을 수 있는 '설정 서버'를 자동으로 찾아주는, 웹 프락시 자동발견 프로토콜(Web Proxy Autodiscovery Protocol, WPAD)를 제공함

> '설정 서버' 를 어떻게 자동으로 찾을 수 있는걸까?

### 6.4.1 클라이언트 프락시 설정: 수동

**주요 브라우저들(크롬, IE 등)은 수동 프락시 설정 기능 제공:**

- 크롬: 설정 → 고급 설정 표시 → 프록시 설정 변경
- ~~IE10: 도구 → 인터넷 옵션 → 연결 → LAN 설정 → 프락시 서버 사용 -> '고급'~~

**프락시 설정 방식:**

- 모든 브라우저가 프락시의 호스트와 포트를 지정하는 방식 사용

**몇몇 ISP의 경우:**

- ISP들은 자신들의 목적(성능, 제어, 보안 등)을 위해 프락시 서버가 미리 설정된 브라우저나, 모든 웹 트래픽을 자동으로 프락시로 보내도록 설정된 맞춤형 운영체제를 구매하여 사용함

### 6.4.2 클라이언트 프락시 설정: PAC 파일

**수동 프락시 설정의 한계:**

- 하나의 프락시 서버만 지정 가능
- 장애 시 대체 작동 지원 없음
- 설정된 브라우저가 매우 많다면, 모두 다 원하는 대로 설정을 변경 하는 것은 어렵거나 불가능

**PAC 파일의 특징:**

- 동적인 프락시 설정 가능
- 프락시 설정을 상황에 맞게 계산해주는 자바스크립트로 작성된 작은 프로그램
- 문서 접근마다 자바스크립트 함수가 적절한 프록시 선택

**PAC 파일 사용법:**

- 브라우저의 '자동 설정'에 PAC 파일의 URI 입력
- PAC 파일은 .pac 확장자를 가지며 MIME 타입은 'application/x-ns-proxy-autoconfig'임
- 각 PAC 파일은 URI에 접근할 때 사용할 적절한 프락시 서버를 계산해주는 FindProxyForUrl(url,host) 함수를 반드시 정의해야함

  ```js
  // PAC 파일
  // HTTP 트랜잭션과 FTP 트랜잭션에 대해 각각 사용할 프락시를 알려줌, 그 외의 다른 모든 종류의 트랜잭션에 대해서는 직접 연결을 하도록 지시

  function FindProxyForURL(urt, host) {
    if (url.substring(0,5) = "http:") {
      return "PROXY http-proxy.mydomain.com:8080";
    } else if (url.substring(0,4) =="ftp:") {
      return "PROXY ftp-proxy.mydomain.com:8080";
    } else {
      return "DIRECT”;
    }
  }
  ```

- FindProxyForUrl의 반환값은 아래의 값들 중 하나임
  - DIRECT -> 프락시 없이 연결이 직접 이루어져야 함
  - PROXY host:port -> 지정한 프락시를 사용해야 함
  - SOCKS host:port -> 지정한 SOCKS 서버를 사용해야 함

### 6.4.3 클라이언트 프락시 설정: WPAD

**WPAD의 기본 개념:**

- 여러 발견 메커니즘을 순차적으로 시도하여 브라우저에게 알맞은 PAC 파일을 자동으로 찾아주는 알고리즘

**WPAD 클라이언트의 작동 순서:**

1. WPAD로 PAC 파일의 URI 찾기
2. 찾은 URI에서 PAC 파일 가져오기
3. PAC 파일 실행하여 프락시 서버 확인
4. 확인된 프락시 서버로 요청 처리

**WPAD의 발견 기법(순서대로):**

1. DHCP (동적 호스트 발견 규약)
2. SLP (서비스 위치 규약)
3. DNS 잘 알려진 호스트명
4. DNS SRV 레코드
5. DNS TXT 레코드 안의 서비스 URI

> 이 설명만으로는 이해가 가지 않는다, 구체적으로 알아봐야지

## 6.5 프락시 요청의 미묘한 특징들
