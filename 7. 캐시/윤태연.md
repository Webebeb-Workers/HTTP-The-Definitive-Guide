# 캐시

> [!NOTE]
> 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치 <br />
> 클라이언트가 요청한 리소스가 캐시에 있다면 서버가 아닌 캐시에서 직접 반환하는 원리

## 캐시의 이점

### **불필요 데이터 전송 감소**

- 똑같은 바이트들을 계속 반복적으로 받으면 그만큼 대역폭을 잡아먹음
- 동일 리소스 반복 전송 방지를 통한 효율성 확보

네트워크 비용 절감을 달성 할 수 있음!

### **네트워크 병목 현상 해결**

광역 통신망 네트워크 속도는 경로상 가장 느린 구간의 속도와 같음, 문서 크기가 클수록 네트워크 대역폭의 영향이 커짐.

<img width="525" alt="image" src="https://github.com/user-attachments/assets/9f5e7e28-d4e2-48f3-a94c-7ca6e57076a5" />

- 클라이언트와 가까운 곳에서 hit가 돼 빠른 응답이 가능
- 대역폭이 작은 병목 구간을 통과하지 않아도 됨
- 로컬 캐시 사용 시 30초 걸리던 5MB 파일을 1초 미만으로 전송 가능

#### 네트워크 종류별 전송 시간 특징

1. **전화식 모뎀 (56Kbps)**
   - 가장 느린 전송 속도
   - 5MB 파일 전송에 약 12분(749초) 소요
   - 작은 HTML 파일(15KB)도 2.19초 소요
2. **DSL (256Kbps)**
   - 모뎀보다 약 4-5배 빠른 속도
   - 5MB 파일 전송에 약 3분(164초) 소요
   - 일반적인 JPEG(40KB) 전송에 1.28초 소요
3. **T1 (1.4Mbps)**
   - DSL보다 약 5배 빠른 속도
   - 5MB 파일 전송에 29초 소요
   - 큰 JPEG(150KB) 전송에도 1초 미만(0.85초) 소요
4. **이더넷 (10Mbps - 100Mbps)**
   - 가장 빠른 전송 속도
   - 느린 이더넷(10Mbps)도 5MB 파일 전송에 4.19초만 소요
   - 빠른 이더넷(100Mbps)은 모든 파일 전송이 1초 미만

특히 큰 파일일수록 캐시를 통한 성능 개선 효과가 극대화됨.

### **갑작스러운 요청 쇄도(Flash Crowds) 처리**

- 인기 있는 이벤트로 인한 트래픽 급증 상황 발생 시 심각한 장애 야기
- 캐싱 사용 시 트래픽 급증 상황에서도 안정적 서비스 제공 가능

서버 부하 감소와 네트워크 혼잡 방지를 할 수 있음.

### **거리로 인한 지연 감소**

대역폭도 문제지만, 물리적 거리가 문제일 수 있다. 네트워크를 전달하는 속도인 빛의 속도(300,000km/s)여도!

<img width="507" alt="image" src="https://github.com/user-attachments/assets/b88c7c7b-4cce-4aaa-96e9-b092f0875eaf" />

- 네트워크 라우터 각각의 지연시간과 합쳐져 실제 전송 시간에 큰 영향 미침
- 클라이언트와 가까운 곳에서 캐시된 데이터 제공
- 라우터 홉수와 물리적 거리 감소를 통한 응답 시간 단축이 가능 => 수천 킬로미터 거리를 수십 미터로 단축

#### 참고: 예시 - 거리별 지연 시간

1. **보스턴-샌프란시스코 구간 (4,400km)**
   - 편도 15밀리초, 왕복 30밀리초의 기본 지연이 특징
   - 20개 이미지, 4개 동시 커넥션 시 240밀리초(1/4초) 지연이 핵심
   - 실제 라우터 지연까지 더해지면 더 긴 지연 발생이 특징
2. **보스턴-도쿄 구간 (10,800km)**
   - 거리가 2.45배 증가해 지연시간도 비례 증가가 특징
   - 같은 조건에서 600밀리초 지연이 발생하는 것이 핵심
   - 복잡한 웹페이지의 경우 수 초 단위 지연이 가능

보통 기계실 근처 캐시 설치로 지연 최소화가 가능함.

## 캐시 처리 단계/종류

<img width="493" alt="image" src="https://github.com/user-attachments/assets/7d78534f-5bce-4270-9c22-be0db211a6d1" />

### 캐시 적중 & 부적중

> [!NOTE]
>
> - 캐시 적중(Cache Hit): 요청한 데이터가 캐시에 존재해 바로 반환
> - 캐시 부적중(Cache Miss): 요청한 데이터가 캐시에 없어 서버에서 가져와야 하는 상황

### 재검사

캐싱은 항상 서버와의 데이터 무결성을 지켜야한다.

#### **재검사 조건**

- 원 서버의 콘텐츠 변경 가능성에 대한 대비 => 캐시된 데이터의 신선도 확인이 필요한 시점을 상시 점검해야함
- 캐시된 사본의 신선도 확인을 위한 주기적 검사 필요
  - 클라이언트 요청이 있거나,
  - 충분히 오래된 경우 수행

#### **재검사 방식**

<img width="508" alt="image" src="https://github.com/user-attachments/assets/17165863-59ce-4183-a906-950b40400cff" />

- `If-Modified-Since` 헤더를 이용한 조건부 요청으로 할 수 있음
  - 서버에게 보내는 GET 요청에 이 헤더를 추가하면 캐시된 시간 이후에 변경된 경우에만 사본을 보내달라는 의미
- 변경되지 않은 경우 `304 Not Modified` 응답으로 효율성 확보가 특징
- 변경된 경우 `200 OK`와 함께 새로운 컨텐츠 전송, 캐싱

### 적중률 분석

> [!NOTE]
> 캐시가 요청을 처리하는 비율

1. **문서 적중률(캐시 적중비)**
   - 캐시가 요청을 처리하는 비율을 0-100%로 표현
   - 보통 40% 정도면 괜찮은 성능으로 평가되는 것이 특징
   - 캐시 크기, 사용자 패턴, 데이터 변경 주기 등에 영향을 받음
2. **바이트 적중률**
   - 캐시를 통해 제공된 바이트 단위로의 비율 측정
   - 실제 트래픽 감소량을 정확히 파악 가능한 것이 특징
   - 대역폭 비용 측정에 더 유용한 지표로 활용 (트래픽의 모든 바이트에 요금 책정 등)

### 적중 여부 판단

- HTTP 자체로는 캐시 적중/비적중 여부 구분 불가능.. => 캐싱이 되고 있는지는 모른다는 것임!
- 데이터 생성일 & `Date` 헤더 비교하거나 응답 생성 시간인 `Age` 헤더를 통한 간접적 판단을 해야함
- `Via` 헤더에 추가 정보를 포함하는 프락시 캐시도 존재

## 캐시 토폴로지(Cache Topology)

캐시는 한 명의 사용자에게만 할당될 수도 있고 반대로 수천 명의 사용자들 간에 공유될 수도 있다.

\+ Topology 뜻은 어떠한 체계적인 분류 또는 위상 배치를 뜻함. 3D에서는 폴리곤의 기하학적 표면 배치 특성, 네트워크는 그를 구성하는 요소(링크, 노드)들의 배치 형태나 망 구성 방식을 뜻함.

### 캐시 유형

<img width="483" alt="image" src="https://github.com/user-attachments/assets/68a922fa-7ef0-41df-97b5-6e9de5ac5fbb" />

사용 범위에 따라 개인 전용 캐시와 공용 캐시로 구분된다.

#### 개인 전용 캐시

- 브라우저에 내장된 개인용 캐시
- 디스크와 메모리에 자주 사용하는 문서 저장
- 크롬의 `about:cache`나 익스플로러의 임시 파일로 확인 가능

#### 공용 프락시 캐시

- 여러 사용자가 공유하는 프락시 서버 형태
- 동일 문서에 대한 중복 다운로드 방지
- 트래픽 감소 효과가 큰 것이 특징

\+ 6장의 “클라이언트 프락시 설정: 수동”을 보면, 동 프락시를 지정하거나 프락시 자동설정 파일을 설정함으로써 브라우저가 프락시 캐시를 사용하도록 설정할 수 있음.

### 캐시 계층 구조

#### **프락시 캐시 계층**

<img width="488" alt="image" src="https://github.com/user-attachments/assets/52baa26f-e5da-4b38-a80e-837d173dee36" />

- 작은 캐시의 부적중을 큰 부모 캐시가 처리하는 구조
- 클라이언트 주변은 작은 캐시, 상위는 큰 캐시 배치
- 계층이 깊어질수록 성능 저하 우려

\+ 참고: 프락시 캐시를 사용하는 과정

1. 사용자가 웹페이지 요청
2. 먼저 가까운 작은 캐시 확인
3. 없으면 큰 캐시 확인
4. 거기도 없으면 원본 서버로 요청

#### **캐시망 구조**

<img width="489" alt="image" src="https://github.com/user-attachments/assets/494c4f50-55f6-4864-944d-7fc463315771" />

캐시 커뮤니케이션 결정을 동적으로 내릴 수 있는 캐시망을 만들어

- URL 기반의 동적 캐시 선택이 가능한 것
- 캐시 간 콘텐츠 공유와 접근 제어
- ICP, HTCP 등 추가 프로토콜로 기능 확장이 필요

한마디로, URL로 원 서버 - 특정 부모 캐시 동적 선택하거나 로컬 탐색 등을 할 수 있게 된다.
